<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrakit Explorer (Alpine.js)</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* --- Styles --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; color: #212529; margin: 0; padding: 2rem; }
        h1, h4 { text-align: center; color: #343a40; }
        h4 { margin-top: 2rem; }
        #search-box { display: block; width: 100%; max-width: 600px; margin: 2rem auto; padding: 1rem; font-size: 1.2rem; border-radius: 8px; border: 1px solid #ced4da; box-sizing: border-box; }
        #results { max-width: 95%; margin: 2rem auto; }
        .result-item { background-color: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .result-item h3 { margin: 0 0 0.5rem 0; cursor: pointer; color: #007bff; }
        .result-item h3:hover { text-decoration: underline; }
        .result-item p { margin: 0.2rem 0; color: #6c757d; }
        .result-item code, .data-table code { background-color: #e9ecef; padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; display: inline-block; /* Helps with wrapping */ }
        .child-container { border-top: 1px solid #e9ecef; margin-top: 1rem; padding-top: 1rem; /* display handled by x-show */ }
        .child-item { margin-left: 20px; padding: 1rem; border-left: 2px solid #e9ecef; margin-top: 1rem; }
        .tabs { display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 1rem; }
        .tab-button { background-color: #f8f9fa; border: 1px solid transparent; border-bottom: none; padding: 0.5rem 1rem; cursor: pointer; font-size: 1em; }
        .tab-button.active { background-color: #fff; border-color: #dee2e6 #dee2e6 #fff; font-weight: bold; }
        .tab-content { /* display handled by x-show */ padding: 1rem 0; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9em; table-layout: fixed; }
        .data-table th, .data-table td { border: 1px solid #dee2e6; padding: 8px; text-align: left; word-wrap: break-word; vertical-align: top; /* Align roles list nicely */ }
        .data-table th { background-color: #f8f9fa; }
        .action-cell-allow { color: #28a745; font-weight: bold; }
        .action-cell-deny { color: #dc3545; font-weight: bold; }
        .allow-cell code { background-color: #d4edda; border-color: #c3e6cb; }
        .status-cell-enabled { color: #28a745; font-weight: bold; } /* Green for enabled SA */
        .status-cell-disabled { color: #dc3545; font-weight: bold; } /* Red for disabled SA */
        .armor-shield { font-size: 1.2em; color: #007bff; }
        .flow-container { display: flex; align-items: stretch; gap: 1rem; margin-top: 1rem; background-color: #f8f9fa; padding: 1rem; border-radius: 8px; }
        .flow-card { flex: 1; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        .flow-card h5 { margin-top: 0; border-bottom: 1px solid #e9ecef; padding-bottom: 0.5rem; color: #495057; }
        .flow-card p { font-size: 0.9em; margin: 0.5rem 0; }
        .flow-arrow { display: flex; align-items: center; font-size: 2.5em; color: #adb5bd; }
        [x-cloak] { display: none !important; } /* Hide elements until Alpine initializes */
        .role-list code { margin-bottom: 0.3em; } /* Spacing between roles */
    </style>
</head>
<body x-data="infrakitExplorer()" x-cloak>
<h1>☁️ Infrakit Explorer</h1>

<input type="text" id="search-box" placeholder="Search for projects, EC2 instances, etc."
       x-model="query"
       x-on:keyup.debounce.500ms="performSearch()">

<div id="results">
    <p x-show="isLoadingSearch">Searching...</p>
    <p x-show="!isLoadingSearch && query.length >= 2 && searchResults.length === 0">No results found.</p>

    <template x-for="result in searchResults" :key="result.id">
        <div class="result-item">
            <h3 x-text="result.name" x-on:click="toggleExpand(result.id, result.service)"></h3>
            <p>
                <strong>ID:</strong> <code x-text="result.id"></code> |
                <strong>Service:</strong> <span x-text="result.service"></span> |
                <strong>Provider:</strong> <span x-text="result.provider"></span>
            </p>

            <div class="child-container" x-show="expandedProjects[result.id]?.visible" x-transition>
                <p x-show="isLoadingDetails[result.id]">Loading details...</p>

                <div x-show="!isLoadingDetails[result.id] && expandedProjects[result.id]?.details">
                    <div class="tabs">
                        <button class="tab-button"
                                :class="{ 'active': expandedProjects[result.id]?.activeTab === 'networking' }"
                                x-on:click="expandedProjects[result.id].activeTab = 'networking'">Networking</button>
                        <button class="tab-button"
                                :class="{ 'active': expandedProjects[result.id]?.activeTab === 'app-infra' }"
                                x-on:click="expandedProjects[result.id].activeTab = 'app-infra'">App Infrastructure</button>
                        <button class="tab-button"
                                :class="{ 'active': expandedProjects[result.id]?.activeTab === 'iam' }"
                                x-on:click="expandedProjects[result.id].activeTab = 'iam'">IAM & Permissions</button>
                    </div>

                    <div class="tab-content" x-show="expandedProjects[result.id]?.activeTab === 'networking'" :class="{'active': expandedProjects[result.id]?.activeTab === 'networking'}">
                        <template x-if="expandedProjects[result.id]?.details?.vpc?.length > 0">
                            <div class="child-item">
                                <h4>VPCs</h4>
                                <template x-for="vpc in expandedProjects[result.id].details.vpc" :key="vpc.id">
                                    <div>
                                        <strong>VPC:</strong> <span x-text="vpc.name"></span>
                                        <template x-if="expandedProjects[result.id].details.subnet?.length > 0">
                                            <div>
                                                <template x-for="subnet in expandedProjects[result.id].details.subnet.filter(s => s.attributes.vpc.endsWith(vpc.id))" :key="subnet.id">
                                                    <div class="child-item">↳ <strong>Subnet:</strong> <span x-text="subnet.name"></span> (<code><span x-text="subnet.attributes.cidr_range"></span></code>)</div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="expandedProjects[result.id]?.details?.firewall?.length > 0">
                            <div class="child-item">
                                <h4>Firewall Rules (<span x-text="expandedProjects[result.id].details.firewall.length"></span>)</h4>
                                <table class="data-table firewall-table">
                                    <thead><tr><th>Priority</th><th>Name</th><th>Direction</th><th>Action</th><th>Protocols/Ports</th><th>Source Ranges</th><th>Destination Ranges</th></tr></thead>
                                    <tbody>
                                    <template x-for="rule in expandedProjects[result.id].details.firewall.sort((a,b) => parseInt(a.attributes.priority) - parseInt(b.attributes.priority))" :key="rule.id">
                                        <tr>
                                            <td><code x-text="rule.attributes.priority"></code></td>
                                            <td x-text="rule.name"></td>
                                            <td><code x-text="rule.attributes.direction"></code></td>
                                            <td :class="{ 'action-cell-allow': rule.attributes.action === 'ALLOW', 'action-cell-deny': rule.attributes.action === 'DENY' }" x-text="rule.attributes.action"></td>
                                            <td><code x-text="rule.attributes.action === 'ALLOW' ? (rule.attributes.allowed || 'none') : (rule.attributes.denied || 'none')"></code></td>
                                            <td :class="{ 'allow-cell': rule.attributes.action === 'ALLOW' }"><code><span x-text="rule.attributes.source_ranges || 'any'"></span></code></td>
                                            <td :class="{ 'allow-cell': rule.attributes.action === 'ALLOW' }"><code><span x-text="rule.attributes.destination_ranges || 'any'"></span></code></td>
                                        </tr>
                                    </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>
                        <p x-show="!expandedProjects[result.id]?.details?.vpc?.length && !expandedProjects[result.id]?.details?.firewall?.length">No networking resources found for this project.</p>
                    </div>

                    <div class="tab-content" x-show="expandedProjects[result.id]?.activeTab === 'app-infra'" :class="{'active': expandedProjects[result.id]?.activeTab === 'app-infra'}">
                        <template x-if="expandedProjects[result.id]?.details?.cloudrun?.length > 0">
                            <div>
                                <h4>Cloud Run Services</h4>
                                <table class="data-table">
                                    <thead><tr><th>Service Name</th><th>URL</th><th>Image</th><th>Region</th><th>Network (VPC)</th><th>Subnet / Connector</th></tr></thead>
                                    <tbody>
                                    <template x-for="cr in expandedProjects[result.id].details.cloudrun" :key="cr.id">
                                        <tr>
                                            <td x-text="cr.name"></td>
                                            <td><a :href="cr.attributes.url" x-text="cr.attributes.url" target="_blank"></a></td>
                                            <td><code x-text="cr.attributes.image"></code></td>
                                            <td x-text="cr.region"></td>
                                            <td><code x-text="(cr.attributes.vpc || 'N/A').split('/').pop()"></code></td>
                                            <td><code x-text="(cr.attributes.subnet || 'N/A').split('/').pop()"></code></td>
                                        </tr>
                                    </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>
                        <div x-data="{ flows: expandedProjects[result.id]?.lbFlows || [] }">
                            <h4>Load Balancers</h4>
                            <p x-show="flows.length === 0 && !isLoadingDetails[result.id]">No complete Load Balancer flows found.</p>
                            <template x-for="flow in flows" :key="flow.name">
                                <div>
                                    <h5>Flow: <span x-text="flow.name"></span></h5>
                                    <div class="flow-container">
                                        <div class="flow-card">
                                            <h5>Frontend: <span x-text="flow.frontend.ipAddress || 'Not Found'"></span></h5>
                                            <p><strong>Port:</strong> <code x-text="flow.frontend.portRange"></code></p>
                                            <p><strong>Protocol:</strong> <code x-text="flow.frontend.protocol"></code></p>
                                        </div>
                                        <div class="flow-arrow">&rarr;</div>
                                        <div class="flow-card">
                                            <h5>Routing Rules</h5>
                                            <template x-for="route in flow.routingRules">
                                                <p><strong>Hosts:</strong> <code x-text="route.hosts.join(', ')"></code></p>
                                            </template>
                                        </div>
                                        <div class="flow-arrow">&rarr;</div>
                                        <div class="flow-card">
                                            <h5>Backend: <span x-text="flow.backend.name"></span></h5>
                                            <p><strong>Type:</strong> <span x-text="flow.backend.type"></span></p>
                                            <p><strong>Service:</strong> <span x-text="flow.backend.serviceName"></span></p>
                                            <template x-if="flow.cloudArmor.name">
                                                <p><span class="armor-shield">🛡️</span> <strong>Cloud Armor:</strong> <span x-text="flow.cloudArmor.name"></span></p>
                                            </template>
                                        </div>
                                    </div>
                                    <hr style="margin: 2rem 0;"/>
                                </div>
                            </template>
                        </div>
                        <p x-show="!expandedProjects[result.id]?.details?.cloudrun?.length && expandedProjects[result.id]?.lbFlows?.length === 0">No application infrastructure found.</p>
                    </div>

                    <div class="tab-content" x-show="expandedProjects[result.id]?.activeTab === 'iam'" :class="{'active': expandedProjects[result.id]?.activeTab === 'iam'}">
                        <template x-if="expandedProjects[result.id]?.details?.serviceaccount?.length > 0">
                            <div>
                                <h4>Service Accounts</h4>
                                <table class="data-table">
                                    <thead><tr><th>Display Name</th><th>Email</th><th>Unique ID</th><th>Disabled</th><th>Project Roles</th></tr></thead>
                                    <tbody>
                                    <template x-for="sa in expandedProjects[result.id].details.serviceaccount" :key="sa.id">
                                        <tr>
                                            <td x-text="sa.name || 'N/A'"></td>
                                            <td><code x-text="sa.attributes.email"></code></td>
                                            <td><code x-text="sa.attributes.unique_id"></code></td>
                                            <td :class="sa.attributes.disabled === 'true' ? 'status-cell-disabled' : 'status-cell-enabled'" x-text="sa.attributes.disabled === 'true' ? 'Yes' : 'No'"></td>
                                            <td class="role-list">
                                                <template x-if="sa.attributes.roles && sa.attributes.roles !== 'No direct roles found' && sa.attributes.roles !== 'Error fetching roles'">
                                                    <template x-for="role in sa.attributes.roles.split(', ')" :key="role">
                                                        <div><code x-text="role"></code></div>
                                                    </template>
                                                </template>
                                                <template x-if="!sa.attributes.roles || sa.attributes.roles === 'No direct roles found' || sa.attributes.roles === 'Error fetching roles'">
                                                    <span x-text="sa.attributes.roles || 'N/A'"></span>
                                                </template>
                                            </td>
                                        </tr>
                                    </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>
                        <p x-show="!expandedProjects[result.id]?.details?.serviceaccount?.length">No Service Accounts found for this project.</p>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
    function infrakitExplorer() {
        return {
            query: '',
            searchResults: [],
            isLoadingSearch: false,
            expandedProjects: {}, // Stores state { id: { visible, activeTab, details, lbFlows, loaded } }
            isLoadingDetails: {}, // Stores loading state { id: bool }

            async performSearch() {
                if (this.query.length < 2) {
                    this.searchResults = [];
                    return;
                }
                this.isLoadingSearch = true;
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(this.query)}`);
                    if (!response.ok) throw new Error('Search failed');
                    this.searchResults = await response.json();
                } catch (error) {
                    console.error("Search error:", error);
                    this.searchResults = [];
                } finally {
                    this.isLoadingSearch = false;
                }
            },

            async toggleExpand(id, type) {
                if (type !== 'project') return;

                if (!this.expandedProjects[id]) {
                    this.expandedProjects[id] = { visible: false, activeTab: 'networking', details: null, lbFlows: [], loaded: false };
                }

                this.expandedProjects[id].visible = !this.expandedProjects[id].visible;

                if (this.expandedProjects[id].visible && !this.expandedProjects[id].loaded) {
                    this.isLoadingDetails[id] = true;
                    try {
                        const [resDetailsResponse, lbFlowsResponse] = await Promise.all([
                            fetch(`/api/resources?parent=${encodeURIComponent(id)}`),
                            fetch(`/api/lb-flows?project=${encodeURIComponent(id)}`)
                        ]);

                        if (!resDetailsResponse.ok) throw new Error(`Failed to fetch project details (${resDetailsResponse.status})`);
                        if (!lbFlowsResponse.ok) throw new Error(`Failed to fetch LB flows (${lbFlowsResponse.status})`);

                        this.expandedProjects[id].details = await resDetailsResponse.json();
                        this.expandedProjects[id].lbFlows = await lbFlowsResponse.json();
                        this.expandedProjects[id].loaded = true;

                    } catch (error) {
                        console.error(`Error fetching details for project ${id}:`, error);
                        // Optionally display error message in UI
                    } finally {
                       this.isLoadingDetails[id] = false;
                    }
                }
            }
        }
    }
</script>
</body>
</html>