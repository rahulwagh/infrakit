<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrakit Explorer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; color: #212529; margin: 0; padding: 2rem; }
        h1 { text-align: center; color: #343a40; }
        #search-box { display: block; width: 100%; max-width: 600px; margin: 2rem auto; padding: 1rem; font-size: 1.2rem; border-radius: 8px; border: 1px solid #ced4da; box-sizing: border-box; }
        #results { max-width: 95%; margin: 2rem auto; }
        .result-item { background-color: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .result-item h3, .expandable-section h4 { margin: 0 0 0.5rem 0; }
        .result-item p { margin: 0.2rem 0; color: #6c757d; }
        .result-item code, .firewall-table code { background-color: #e9ecef; padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; }
        .expandable { cursor: pointer; color: #007bff; }
        .expandable:hover { text-decoration: underline; }
        .child-container { border-top: 1px solid #e9ecef; margin-top: 1rem; padding-top: 1rem; display: none; }
        .child-item { margin-left: 20px; padding: 0.5rem; border-left: 2px solid #e9ecef; }
        .firewall-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9em; table-layout: fixed; }
        .firewall-table th, .firewall-table td { border: 1px solid #dee2e6; padding: 8px; text-align: left; word-wrap: break-word; }
        .firewall-table th { background-color: #f8f9fa; }
        .firewall-table tr:hover { background-color: #f1f1f1; }
        .action-cell-allow { color: #28a745; font-weight: bold; }
        .action-cell-deny { color: #dc3545; font-weight: bold; }
        .allow-cell code { background-color: #d4edda; border-color: #c3e6cb; }
    </style>
</head>
<body>
<h1>☁️ Infrakit Explorer</h1>
<input type="text" id="search-box" placeholder="Search for projects, EC2 instances, etc.">
<div id="results"></div>

<script>
    const searchBox = document.getElementById('search-box');
    const resultsDiv = document.getElementById('results');

    const performSearch = async () => {
        const query = searchBox.value;
        resultsDiv.innerHTML = (query.length > 0) ? '<p>Searching...</p>' : '';
        if (query.length < 2) {
            resultsDiv.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            if (!response.ok) {
                resultsDiv.innerHTML = `<p>Error: ${await response.text()}</p>`;
                return;
            }
            const results = await response.json();
            resultsDiv.innerHTML = '';

            if (results && results.length > 0) {
                results.forEach(res => {
                    if (res.service === 'project' || res.service === 'ec2') {
                        const item = document.createElement('div');
                        item.className = 'result-item';
                        item.innerHTML = `
                            <h3 class="expandable" data-id="${res.id}" data-type="${res.service}">${res.name}</h3>
                            <p><strong>ID:</strong> <code>${res.id}</code> | <strong>Service:</strong> ${res.service} | <strong>Provider:</strong> ${res.provider}</p>
                            <div class="child-container" id="children-${res.id}" style="display: none;"></div>
                        `;
                        resultsDiv.appendChild(item);
                    }
                });
            } else {
                resultsDiv.innerHTML = '<p>No results found.</p>';
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p>Error fetching results. Is the server running?</p>`;
        }
    };

    const fetchAndDisplayChildren = async (parentId, parentType, container) => {
        if (container.dataset.loaded === 'true') {
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
            return;
        }
        if (parentType !== 'project') {
            container.innerHTML = '<p>No further details available for this resource type.</p>';
            container.style.display = 'block';
            container.dataset.loaded = 'true';
            return;
        }

        container.innerHTML = '<p>Loading details...</p>';
        container.style.display = 'block';

        try {
            const response = await fetch(`/api/resources?parent=${encodeURIComponent(parentId)}`);
            const children = await response.json();
            container.innerHTML = '';
            container.dataset.loaded = 'true';

            if (children.vpc && children.vpc.length > 0) {
                children.vpc.forEach(vpc => {
                    let subnetsHTML = '';
                    if (children.subnet) {
                        children.subnet.filter(s => s.attributes.vpc.endsWith(vpc.id)).forEach(subnet => {
                            subnetsHTML += `<div class="child-item">↳ <strong>Subnet:</strong> ${subnet.name} (<code>${subnet.attributes.cidr_range}</code>)</div>`;
                        });
                    }
                    container.innerHTML += `<div class="child-item"><strong>VPC:</strong> ${vpc.name}${subnetsHTML}</div>`;
                });
            }

            if (children.firewall && children.firewall.length > 0) {
                let tableRows = '';
                children.firewall.sort((a,b) => a.attributes.priority - b.attributes.priority).forEach(rule => {
                    const isAllowRule = rule.attributes.action === 'ALLOW';
                    const actionClass = isAllowRule ? 'action-cell-allow' : 'action-cell-deny';
                    const ipRangeClass = isAllowRule ? 'allow-cell' : '';
                    const ruleDetails = isAllowRule ? rule.attributes.allowed : rule.attributes.denied;

                    tableRows += `
                        <tr>
                            <td><code>${rule.attributes.priority}</code></td>
                            <td>${rule.name}</td>
                            <td><code>${rule.attributes.direction}</code></td>
                            <td class="${actionClass}">${rule.attributes.action}</td>
                            <td><code>${ruleDetails || 'none'}</code></td>
                            <td class="${ipRangeClass}"><code>${rule.attributes.source_ranges || 'any'}</code></td>
                            <td class="${ipRangeClass}"><code>${rule.attributes.destination_ranges || 'any'}</code></td>
                            <td><code>${rule.attributes.target_tags || 'any'}</code></td>
                        </tr>
                    `;
                });

                container.innerHTML += `
                    <div class="child-item">
                        <h4 class="expandable" data-type="firewall-list">Firewall Rules (${children.firewall.length})</h4>
                        <div class="child-container" id="firewall-children-${parentId}" style="display: none;">
                            <table class="firewall-table">
                                <thead>
                                    <tr>
                                        <th>Priority</th>
                                        <th>Name</th>
                                        <th>Direction</th>
                                        <th>Action</th>
                                        <th>Protocols/Ports</th>
                                        <th>Source Ranges</th>
                                        <th>Destination Ranges</th>
                                        <th>Target Tags</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }

        } catch(e) {
            container.innerHTML = '<p>Could not load details.</p>';
        }
    };

    searchBox.addEventListener('keyup', performSearch);

    resultsDiv.addEventListener('click', (event) => {
        const target = event.target;
        if (target && target.classList.contains('expandable')) {
            const type = target.dataset.type;
            const id = target.dataset.id;

            if (type === 'project' || type === 'ec2') {
                const container = document.getElementById(`children-${id}`);
                fetchAndDisplayChildren(id, type, container);
            } else if (type === 'firewall-list') {
                const container = target.nextElementSibling;
                if (container) {
                    container.style.display = container.style.display === 'none' ? 'block' : 'none';
                }
            }
        }
    });
</script>
</body>
</html>